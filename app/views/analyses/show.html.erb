<div class="max-w-7xl mx-auto px-6 py-12">
  <%= link_to analyses_path, class: "inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-8 transition-colors" do %>
    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
    Back to Analyses
  <% end %>

  <div class="mb-10">
    <div class="flex items-center space-x-4 mb-4">
      <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-emerald-500 rounded-2xl flex items-center justify-center shadow-lg">
        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
        </svg>
      </div>
      <div>
        <h1 class="text-4xl font-bold text-gray-900"><%= @upload.name.present? ? @upload.name : "Analysis ##{@upload.id}" %></h1>
        <div class="flex items-center space-x-3 mt-2">
          <p class="text-gray-600"><%= @upload.updated_at.strftime("%B %d, %Y at %I:%M %p") %></p>
          <% if @upload.industry_type && @upload.industry_type != 'other' %>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
              <%= IndustryPromptsService.for_industry(@upload.industry_type)[:name] %>
            </span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Interactive Q&A Section %>
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
    <div class="flex items-center space-x-3 mb-4">
      <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h2 class="text-2xl font-bold text-gray-900">Ask AI About Your Data</h2>
    </div>
    <p class="text-gray-600 mb-4 text-sm">Ask questions about your data and get instant AI-powered insights.</p>
    
    <%= form_with url: ask_analysis_question_path(@upload.id), method: :post, local: true, class: "space-y-4" do |f| %>
      <div>
        <%= text_field_tag :question, params[:question], 
            placeholder: "e.g., What's the average revenue per service? Which staff member generates the most revenue?",
            class: "w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",
            required: true %>
      </div>
      <div class="flex items-center justify-between">
        <p class="text-xs text-gray-500">Powered by OpenAI GPT-4o-mini</p>
        <%= f.submit "Ask Question", class: "bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" %>
      </div>
    <% end %>
    
    <% if @answer && @data_question %>
      <div class="mt-4 flex items-center justify-end">
        <div class="bg-green-100 text-green-700 px-4 py-2 rounded-lg text-sm font-medium flex items-center space-x-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span>Answer saved</span>
        </div>
      </div>
    <% end %>
    
    <% if @answer %>
      <div class="mt-6 pt-6 border-t border-gray-200 space-y-4">
        <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl p-5 border border-blue-200">
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="flex-1">
              <p class="text-xs font-semibold text-blue-700 uppercase tracking-wide mb-1">Your Question</p>
              <p class="text-gray-900 font-medium text-lg"><%= @question %></p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border border-green-200 shadow-sm">
          <div class="flex items-start space-x-3 mb-4">
            <svg class="w-6 h-6 text-green-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            <div>
              <p class="text-xs font-semibold text-green-700 uppercase tracking-wide mb-1">AI Answer</p>
            </div>
          </div>
          <div class="prose prose-base max-w-none">
            <div class="text-gray-800 leading-relaxed space-y-4">
              <%= format_answer(@answer).html_safe %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <%# Saved Questions Section %>
  <% if @saved_questions.any? %>
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900">Saved Questions & Answers</h2>
        </div>
      </div>
      
      <div class="space-y-4">
        <% @saved_questions.each do |data_question| %>
          <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1">
                <p class="text-sm font-medium text-gray-900 mb-1"><%= data_question.question %></p>
                <p class="text-xs text-gray-500"><%= data_question.created_at.strftime("%B %d, %Y at %I:%M %p") %></p>
              </div>
            </div>
            <div class="bg-gray-50 rounded-lg p-3">
              <div class="prose prose-sm max-w-none">
                <%= format_answer(data_question.answer).html_safe %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Charts Section %>
  <% if @chart_data && @chart_data.any? %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <% if @chart_data[:service_revenue] %>
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue by Service</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="serviceRevenueChart"></canvas>
          </div>
        </div>
      <% end %>
      
      <% if @chart_data[:staff_revenue] %>
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue by Staff Member</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="staffRevenueChart"></canvas>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Main Analysis Content %>
  <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
    <div class="bg-gradient-to-r from-green-600 to-emerald-600 px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold text-white mb-2">AI-Generated Recommendations</h2>
          <p class="text-green-100 text-sm">Powered by OpenAI GPT-4o-mini</p>
        </div>
        <%= button_to analyze_with_openai_upload_path(@upload), method: :post, 
            class: "bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-medium text-sm transition-all",
            data: { turbo_method: :post } do %>
          <span class="flex items-center space-x-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span>Re-analyze</span>
          </span>
        <% end %>
      </div>
    </div>

    <div class="p-8">
      <div class="prose prose-lg max-w-none">
        <%= format_recommendations(@upload.open_ai_recommendations).html_safe %>
      </div>
    </div>
  </div>

  <%# Quick Stats %>
  <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
        </div>
        <div>
          <p class="text-sm text-gray-600">Data Points</p>
          <p class="text-2xl font-bold text-gray-900"><%= @row_count %></p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <div>
          <p class="text-sm text-gray-600">Analysis Status</p>
          <p class="text-2xl font-bold text-gray-900">Complete</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
          </svg>
        </div>
        <div>
          <p class="text-sm text-gray-600">Source Data</p>
          <%= link_to upload_path(@upload), class: "text-2xl font-bold text-purple-600 hover:text-purple-700 transition-colors" do %>
            View Upload
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<%# Chart.js for graphs %>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  <% if @chart_data && @chart_data[:service_revenue] %>
    const serviceCtx = document.getElementById('serviceRevenueChart');
    if (serviceCtx) {
      new Chart(serviceCtx, {
        type: 'bar',
        data: {
          labels: <%= raw @chart_data[:service_revenue].keys.to_json %>,
          datasets: [{
            label: 'Revenue ($)',
            data: <%= raw @chart_data[:service_revenue].values.to_json %>,
            backgroundColor: 'rgba(34, 197, 94, 0.8)',
            borderColor: 'rgba(34, 197, 94, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            }
          }
        }
      });
    }
  <% end %>

  <% if @chart_data && @chart_data[:staff_revenue] %>
    const staffCtx = document.getElementById('staffRevenueChart');
    if (staffCtx) {
      new Chart(staffCtx, {
        type: 'doughnut',
        data: {
          labels: <%= raw @chart_data[:staff_revenue].keys.to_json %>,
          datasets: [{
            label: 'Revenue ($)',
            data: <%= raw @chart_data[:staff_revenue].values.to_json %>,
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',
              'rgba(59, 130, 246, 0.8)',
              'rgba(168, 85, 247, 0.8)',
              'rgba(236, 72, 153, 0.8)',
              'rgba(251, 146, 60, 0.8)'
            ],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': $' + context.parsed.toFixed(2);
                }
              }
            }
          }
        }
      });
    }
  <% end %>
</script>

